{
  "permissions": {
    "allow": [
      "Bash(gh auth status:*)",
      "Bash(git init:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(winget install:*)",
      "Bash(\"C:\\\\Program Files\\\\GitHub CLI\\\\gh.exe\" --version)",
      "Bash(\"C:\\\\Program Files \\(x86\\)\\\\GitHub CLI\\\\gh.exe\" --version)",
      "Bash(gh --version:*)",
      "Bash(git remote add:*)",
      "Bash(git branch:*)",
      "Bash(git push:*)",
      "Bash(npx vercel:*)",
      "Bash(npm install:*)",
      "Bash(npm run build:*)",
      "Bash(npx next build)",
      "Bash(npx next build:*)",
      "Bash(node_modules/.bin/next build)",
      "Bash(dir:*)",
      "Bash(cd:*)",
      "Bash(cat:*)",
      "Bash(ls:*)",
      "Bash(docker --version:*)",
      "Bash(docker-compose:*)",
      "Bash(npx tsc --noEmit)",
      "WebFetch(domain:www.data.go.kr)",
      "Bash(fly version:*)",
      "Bash(fly auth whoami:*)",
      "Bash(fly apps create:*)",
      "Bash(fly postgres create:*)",
      "Bash(fly postgres attach:*)",
      "Bash(fly secrets set:*)",
      "Bash(fly deploy:*)",
      "Bash(curl:*)",
      "Bash(fly apps list:*)",
      "Bash(echo:*)",
      "Bash(fly apps restart:*)",
      "Bash(fly status:*)",
      "Bash(fly scale count:*)",
      "Bash(fly machine start:*)",
      "Bash(fly logs:*)",
      "Bash(fly secrets list:*)",
      "Bash(gh repo edit:*)",
      "Bash(gh repo view:*)",
      "Bash(find:*)",
      "Bash(grep:*)",
      "Bash(tree:*)",
      "Bash(python:*)",
      "Bash(node:*)",
      "WebSearch",
      "Bash(wc:*)",
      "Bash(git config:*)",
      "Bash(xargs ls:*)",
      "Bash(powershell -Command \"\n$content = Get-Content -Path ''payments.py'' -Raw\n\n$oldCode = @''\n@router.post\\(\"\"/webhook\"\"\\)\nasync def payment_webhook\\(request: Request, db: AsyncSession = Depends\\(get_db\\)\\):\n    \"\"\"\"\"\"토스페이먼츠 웹훅 처리\"\"\"\"\"\"\n    try:\n        body = await request.json\\(\\)\n        event_type = body.get\\(\"\"eventType\"\"\\)\n        data = body.get\\(\"\"data\"\", {}\\)\n\n        if event_type == \"\"PAYMENT_STATUS_CHANGED\"\":\n            payment_key = data.get\\(\"\"paymentKey\"\"\\)\n            status = data.get\\(\"\"status\"\"\\)\n\n            # 결제 상태 업데이트\n            result = await db.execute\\(\n                select\\(Payment\\).where\\(Payment.payment_key == payment_key\\)\n            \\)\n            payment = result.scalar_one_or_none\\(\\)\n\n            if payment:\n                new_status = {\n                    \"\"DONE\"\": PaymentStatus.COMPLETED,\n                    \"\"CANCELED\"\": PaymentStatus.CANCELED,\n                    \"\"PARTIAL_CANCELED\"\": PaymentStatus.REFUNDED,\n                }.get\\(status\\)\n\n                if new_status:\n                    payment.status = new_status\n                    await db.commit\\(\\)\n\n        return {\"\"status\"\": \"\"ok\"\"}\n\n    except Exception as e:\n        return {\"\"status\"\": \"\"error\"\", \"\"message\"\": str\\(e\\)}\n''@\n\n$newCode = @''\ndef verify_webhook_signature\\(payload: bytes, signature: str, secret_key: str\\) -> bool:\n    import hmac, hashlib, base64\n    expected = base64.b64encode\\(hmac.new\\(secret_key.encode\\(\\), payload, hashlib.sha256\\).digest\\(\\)\\).decode\\(\\)\n    return hmac.compare_digest\\(signature, expected\\)\n\n\n@router.post\\(\"\"/webhook\"\"\\)\nasync def payment_webhook\\(request: Request, db: AsyncSession = Depends\\(get_db\\)\\):\n    \"\"\"\"\"\"토스페이먼츠 웹훅 처리\"\"\"\"\"\"\n    import os, json, logging\n    logger = logging.getLogger\\(__name__\\)\n    \n    signature = request.headers.get\\(\"\"Toss-Signature\"\", \"\"\"\"\\)\n    secret_key = os.getenv\\(\"\"TOSS_SECRET_KEY\"\", \"\"\"\"\\)\n    payload = await request.body\\(\\)\n    \n    if signature and secret_key and not verify_webhook_signature\\(payload, signature, secret_key\\):\n        logger.warning\\(\"\"Invalid webhook signature\"\"\\)\n        return {\"\"status\"\": \"\"error\"\", \"\"message\"\": \"\"Invalid signature\"\"}\n\n    try:\n        body = json.loads\\(payload\\)\n        event_type = body.get\\(\"\"eventType\"\"\\)\n        data = body.get\\(\"\"data\"\", {}\\)\n\n        if event_type == \"\"PAYMENT_STATUS_CHANGED\"\":\n            payment_key = data.get\\(\"\"paymentKey\"\"\\)\n            payment_status = data.get\\(\"\"status\"\"\\)\n            result = await db.execute\\(select\\(Payment\\).where\\(Payment.payment_key == payment_key\\)\\)\n            payment = result.scalar_one_or_none\\(\\)\n            if payment:\n                new_status = {\"\"DONE\"\": PaymentStatus.COMPLETED, \"\"CANCELED\"\": PaymentStatus.CANCELED, \"\"PARTIAL_CANCELED\"\": PaymentStatus.REFUNDED}.get\\(payment_status\\)\n                if new_status:\n                    payment.status = new_status\n                    await db.commit\\(\\)\n                    logger.info\\(f\"\"Payment {payment_key} updated to {new_status}\"\"\\)\n\n        return {\"\"status\"\": \"\"ok\"\"}\n    except json.JSONDecodeError:\n        return {\"\"status\"\": \"\"error\"\", \"\"message\"\": \"\"Invalid JSON\"\"}\n    except Exception as e:\n        logger.error\\(f\"\"Webhook error: {e}\"\"\\)\n        return {\"\"status\"\": \"\"error\"\", \"\"message\"\": \"\"Internal error\"\"}\n''@\n\n$content = $content -replace [regex]::Escape\\($oldCode\\), $newCode\nSet-Content -Path ''payments.py'' -Value $content -NoNewline\nWrite-Host ''Done''\n\")",
      "Bash(powershell -Command \"\n$content = Get-Content -Path ''prospect.py'' -Raw\n\n# Add import json at top and whitelist\n$content = $content -replace ''from pydantic import BaseModel, Field'', ''from pydantic import BaseModel, Field\nimport json\n\n# SQL Injection prevention whitelist\nALLOWED_SORT_COLUMNS = {\"\"prospect_score\"\", \"\"years_operated\"\", \"\"monthly_revenue\"\"}''\n\n# Fix regex -> pattern for Pydantic v2\n$content = $content -replace ''regex='', ''pattern=''\n\n# Add whitelist check before ORDER BY\n$content = $content -replace ''where_sql = \"\" AND \"\".join\\\\\\\\\\(where_clauses\\\\\\\\\\) if where_clauses else \"\"1=1\"\"'', ''where_sql = \"\" AND \"\".join\\(where_clauses\\) if where_clauses else \"\"1=1\"\"\n\n        # SQL Injection prevention - validate sort column\n        if sort_by not in ALLOWED_SORT_COLUMNS:\n            sort_by = \"\"prospect_score\"\"''\n\n# Remove duplicate import json inside loop\n$content = $content -replace ''            import json\\\\r?\\\\n            score_factors'', ''            score_factors''\n\nSet-Content -Path ''prospect.py'' -Value $content -NoNewline\nWrite-Host ''Prospect.py updated''\n\")",
      "Bash(powershell -Command \"\n$content = Get-Content -Path ''websocket.py'' -Raw\n\n# Fix imports\n$content = $content -replace ''from app.core.security import decode_access_token'', ''from app.core.security import verify_token as security_verify_token''\n$content = $content -replace ''from app.core.database import AsyncSessionLocal'', ''from app.core.database import async_session''\n\n# Fix verify_token function\n$content = $content -replace ''payload = decode_access_token\\\\\\\\\\(token\\\\\\\\\\)'', ''payload = security_verify_token\\(token\\)''\n\n# Fix AsyncSessionLocal usage\n$content = $content -replace ''async with AsyncSessionLocal\\\\\\\\\\(\\\\\\\\\\) as db:'', ''async with async_session\\(\\) as db:''\n\nSet-Content -Path ''websocket.py'' -Value $content -NoNewline\nWrite-Host ''WebSocket.py updated''\n\")",
      "Bash(powershell -Command \"\\(Get-Content config.py -Raw\\) -replace ''from pydantic_settings import BaseSettings'',''from pydantic_settings import BaseSettings\\\\nfrom pydantic import field_validator\\\\nimport warnings'' | Set-Content config.py -NoNewline\")",
      "Bash(powershell -Command:*)",
      "Bash(pip show:*)",
      "Bash(pip install:*)",
      "Bash(uvicorn app.main:app:*)",
      "Bash(timeout /t 5 /nobreak)",
      "Bash(where:*)",
      "Bash(flyctl auth whoami:*)",
      "Bash(flyctl deploy:*)",
      "Bash(npx tsc:*)",
      "Bash(npm run lint:*)",
      "Bash(tasklist:*)",
      "Bash(taskkill:*)"
    ]
  }
}
